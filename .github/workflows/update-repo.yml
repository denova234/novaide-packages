name: Update Package Repository

on:
  release:
    types: [published, edited, released]
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 0 * * 0'  # Weekly updates

jobs:
  update-repository:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        sudo apt-get update
        sudo apt-get install -y jq
        
    - name: Generate package index
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO_OWNER: nova-ide
        REPO_NAME: novaide-packages
      run: |
        chmod +x scripts/update-packages-index.sh
        scripts/update-packages-index.sh
        
    - name: Create basic index.html
      run: |
        cat > index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>Nova IDE Packages</title>
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                .header { background: #f0f8ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
                code { background: #f4f4f4; padding: 2px 5px; border-radius: 3px; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Nova IDE Termux Repository</h1>
                <p>Add this repository to Termux:</p>
                <code>echo "deb [trusted=yes] https://nova-ide.github.io/novaide-packages/ stable main" >> \$PREFIX/etc/apt/sources.list</code>
                <p>Then run: <code>pkg update && pkg install [package-name]</code></p>
            </div>
            <p>Repository automatically updated on release publication.</p>
        </body>
        </html>
        EOF
        
    - name: Commit and push changes
      run: |
        git config --local user.email "alexnova205@gmail.com"
        git config --local user.name "Alex Nova"
        git add .
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update package index - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi
